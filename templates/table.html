{% extends "base.html" %}

{% block title %}Prediction Results - Network Security{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-chart-bar"></i> Prediction Results</h4>
                    <div>
                        <a href="/predict-ui" class="btn btn-light btn-sm me-2">
                            <i class="fas fa-upload"></i> New Analysis
                        </a>
                        <button class="btn btn-success btn-sm" onclick="downloadResults()">
                            <i class="fas fa-download"></i> Download CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Analysis Complete:</strong> The prediction results are displayed below. 
                        Rows marked as '1' indicate potential phishing threats.
                    </div>
                    
                    <div class="table-responsive">
                        {{ table|safe }}
                    </div>
                    
                    <!-- Summary Statistics -->
                    {% if total_samples %}
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Prediction Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h3 class="text-primary">{{ total_samples }}</h3>
                                            <p class="mb-0">Total Samples Processed</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h3 class="text-success">{{ safe_count }}</h3>
                                            <p class="mb-0">Safe ({{ safe_percentage }}%)</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h3 class="text-danger">{{ threat_count }}</h3>
                                            <p class="mb-0">Threats ({{ threat_percentage }}%)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Visual Progress Bar -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>Risk Distribution:</strong></label>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ safe_percentage }}%">
                                            Safe {{ safe_percentage }}%
                                        </div>
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ threat_percentage }}%">
                                            Threats {{ threat_percentage }}%
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Assessment -->
                                <div class="alert {% if threat_percentage > 50 %}alert-danger{% elif threat_percentage > 25 %}alert-warning{% else %}alert-success{% endif %}">
                                    <i class="fas {% if threat_percentage > 50 %}fa-exclamation-triangle{% elif threat_percentage > 25 %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                                    <strong>Risk Assessment:</strong>
                                    {% if threat_percentage > 50 %}
                                        High Risk - More than half of the samples are identified as threats
                                    {% elif threat_percentage > 25 %}
                                        Medium Risk - Significant number of threats detected
                                    {% else %}
                                        Low Risk - Most samples appear to be safe
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Count predictions
    const table = document.getElementById('prediction-table');
    if (table) {
        const rows = table.querySelectorAll('tbody tr');
        let safeCount = 0;
        let threatCount = 0;
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const lastCell = cells[cells.length - 1];
            if (lastCell && lastCell.textContent.trim() === '1') {
                threatCount++;
                row.classList.add('table-danger');
            } else {
                safeCount++;
                row.classList.add('table-success');
            }
        });
        
        document.getElementById('safeCount').textContent = safeCount;
        document.getElementById('threatCount').textContent = threatCount;
        
        const total = safeCount + threatCount;
        const threatRate = total > 0 ? ((threatCount / total) * 100).toFixed(1) + '%' : '0%';
        document.getElementById('threatRate').textContent = threatRate;
        
        // Style the table
        table.classList.add('table', 'table-striped', 'table-hover');
    }
});

function downloadResults() {
    window.location.href = '/prediction_output/output.csv';
}
</script>
{% endblock %}