{% extends "base.html" %}

{% block title %}Model Training - Network Security{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-cog"></i> Model Training</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Training Process:</strong> This will retrain the machine learning model with the latest data to improve detection accuracy.
                    </div>

                    <div id="trainingStatus" class="mb-4">
                        <h6>Training Status: <span id="statusText" class="badge bg-secondary">Ready</span></h6>
                        <div class="progress mt-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <button id="startTraining" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-play"></i> Start Training
                    </button>

                    <div id="trainingLog" class="mt-4 d-none">
                        <h6>Training Log:</h6>
                        <div class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto;">
                            <div id="logContent"></div>
                        </div>
                    </div>

                    <div id="trainingResult" class="mt-4 d-none">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Training Completed Successfully!</strong>
                            <p class="mb-0 mt-2">The model has been updated and is ready for predictions.</p>
                        </div>
                    </div>

                    <div id="trainingError" class="mt-4 d-none">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Training Failed:</strong>
                            <p class="mb-0 mt-2" id="errorText"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Training Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Training Process Includes:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i> Data Ingestion</li>
                                    <li><i class="fas fa-check text-success me-2"></i> Data Validation</li>
                                    <li><i class="fas fa-check text-success me-2"></i> Data Transformation</li>
                                    <li><i class="fas fa-check text-success me-2"></i> Model Training</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Expected Duration:</h6>
                                <p class="text-muted">Training typically takes 5-15 minutes depending on data size and system performance.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startTraining');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const trainingLog = document.getElementById('trainingLog');
    const logContent = document.getElementById('logContent');
    const trainingResult = document.getElementById('trainingResult');
    const trainingError = document.getElementById('trainingError');

    // Check training status on page load
    checkTrainingStatus();

    startBtn.addEventListener('click', function() {
        startTraining();
    });

    function checkTrainingStatus() {
        fetch('/training-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                statusText.textContent = 'Completed';
                statusText.className = 'badge bg-success';
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                startBtn.innerHTML = '<i class="fas fa-redo"></i> Retrain Model';
                trainingResult.classList.remove('d-none');
            } else {
                statusText.textContent = 'Ready';
                statusText.className = 'badge bg-secondary';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Training';
            }
        })
        .catch(error => {
            console.error('Error checking training status:', error);
        });
    }

    function startTraining() {
        startBtn.disabled = true;
        statusText.textContent = 'Training...';
        statusText.className = 'badge bg-warning';
        trainingLog.classList.remove('d-none');
        trainingResult.classList.add('d-none');
        trainingError.classList.add('d-none');
        
        // Reset progress
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        
        // Add log messages
        addLogMessage('Starting training pipeline...');
        addLogMessage('Initializing data ingestion...');
        
        // Start progress simulation
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 5;
            if (progress > 95) progress = 95;
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }, 1000);
        
        fetch('/train', {
            method: 'GET'
        })
        .then(response => {
            clearInterval(progressInterval);
            
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        })
        .then(result => {
            // Complete progress
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            
            console.log('Training response:', result); // Debug log
            addLogMessage('Received response: ' + JSON.stringify(result));
            
            if (result.status === 'success') {
                statusText.textContent = 'Completed';
                statusText.className = 'badge bg-success';
                addLogMessage('Data validation completed');
                addLogMessage('Model training completed');
                addLogMessage(result.message || 'Training pipeline finished successfully!');
                trainingResult.classList.remove('d-none');
                startBtn.innerHTML = '<i class="fas fa-redo"></i> Retrain Model';
            } else {
                statusText.textContent = 'Failed';
                statusText.className = 'badge bg-danger';
                addLogMessage('Training failed: ' + (result.message || 'Unknown error'));
                document.getElementById('errorText').textContent = result.message || 'Unknown error';
                trainingError.classList.remove('d-none');
            }
            startBtn.disabled = false;
        })
        .catch(error => {
            clearInterval(progressInterval);
            statusText.textContent = 'Failed';
            statusText.className = 'badge bg-danger';
            addLogMessage('Error: ' + error.message);
            document.getElementById('errorText').textContent = error.message;
            trainingError.classList.remove('d-none');
            startBtn.disabled = false;
        });
    }

    function addLogMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logContent.scrollTop = logContent.scrollHeight;
    }
});
</script>
{% endblock %}